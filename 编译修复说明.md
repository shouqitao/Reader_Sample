# 编译修复说明

## 修复的编译错误

### 1. C# 6.0 属性初始化语法错误
**问题**: 在 `CardReaderConfig` 类中使用了 C# 6.0 的属性初始化语法
```csharp
public int UsbPort { get; set; } = 1001;  // 不兼容 .NET Framework 4.8
```

**修复**: 改为使用构造函数初始化
```csharp
public int UsbPort { get; set; }

public CardReaderConfig()
{
    UsbPort = 1001;
    SerialPort = 1;
    UseUsb = true;
    TimeoutSeconds = 10;
    PhotoSavePath = Environment.CurrentDirectory;
    AutoBeep = false;
}
```

### 2. C# 8.0 Switch 表达式语法错误
**问题**: 在 `MainWindow.xaml.cs` 中使用了 C# 8.0 的 switch 表达式
```csharp
return cardType switch
{
    CardType.IdCard => "身份证",
    // ...
    _ => "未知卡片"
};
```

**修复**: 改为传统的 switch 语句
```csharp
switch (cardType)
{
    case CardType.IdCard:
        return "身份证";
    // ...
    default:
        return "未知卡片";
}
```

### 3. 异常类构造函数缺失
**问题**: `DeviceInitializationException` 等异常类缺少接受 `Exception` 参数的构造函数

**修复**: 为所有异常类添加缺失的构造函数
```csharp
public DeviceInitializationException(string message, Exception innerException) 
    : base(message, innerException)
{
}
```

## 编译环境要求

### 必需软件
- **Visual Studio 2017** 或更高版本
- **.NET Framework 4.8** 开发包
- **MSBuild 15.0** 或更高版本

### 平台设置
- **目标平台**: x86
- **目标框架**: .NET Framework 4.8
- **C# 语言版本**: 7.3

## 编译步骤

### 方法1: 使用批处理文件（推荐）
```bash
# 运行编译脚本
build.bat
```

### 方法2: 使用 Visual Studio
1. 打开 `CardReader.sln`
2. 设置解决方案配置为 `Debug`
3. 设置解决方案平台为 `x86`
4. 右键解决方案 → 生成解决方案

### 方法3: 使用 MSBuild 命令行
```bash
# 编译整个解决方案
msbuild CardReader.sln /p:Configuration=Debug /p:Platform=x86

# 单独编译项目
msbuild CardReaderLib\CardReaderLib.csproj /p:Configuration=Debug /p:Platform=x86
msbuild CardReaderWPF\CardReaderWPF.csproj /p:Configuration=Debug /p:Platform=x86
```

## 输出文件位置

编译成功后，生成的文件位于：

- **CardReaderLib.dll**: `CardReaderLib\bin\x86\Debug\CardReaderLib.dll`
- **CardReaderWPF.exe**: `CardReaderWPF\bin\Debug\CardReaderWPF.exe`

## 常见编译问题解决

### 问题1: 找不到 MSBuild
**解决方案**: 
- 安装 Visual Studio 2017 或更高版本
- 或安装 Build Tools for Visual Studio
- 或将 MSBuild 路径添加到系统 PATH

### 问题2: .NET Framework 4.8 未安装
**解决方案**:
- 下载并安装 .NET Framework 4.8 Developer Pack
- 从微软官网下载: https://dotnet.microsoft.com/download/dotnet-framework/net48

### 问题3: 平台不匹配错误
**解决方案**:
- 确保使用 x86 平台编译
- 检查项目引用是否正确设置为 x86

### 问题4: 缺少引用
**解决方案**:
- 确保 CardReaderWPF 正确引用了 CardReaderLib 项目
- 检查所有 NuGet 包是否已恢复

## 验证编译结果

编译完成后，可以通过以下方式验证：

1. **检查输出文件**
   ```bash
   dir CardReaderLib\bin\x86\Debug\CardReaderLib.dll
   dir CardReaderWPF\bin\Debug\CardReaderWPF.exe
   ```

2. **运行WPF程序**
   ```bash
   CardReaderWPF\bin\Debug\CardReaderWPF.exe
   ```

3. **检查依赖关系**
   - CardReaderWPF.exe 应该能够找到 CardReaderLib.dll
   - 程序启动时不应该出现缺少程序集的错误

## 部署说明

部署时需要包含以下文件：
- `CardReaderWPF.exe`
- `CardReaderLib.dll`
- 读卡器驱动 DLL 文件 (`SSSE32.dll`, `HDstdapi.dll`)
- .NET Framework 4.8 运行时

## 注意事项

1. **必须使用 x86 平台编译**，因为读卡器驱动通常为 32 位
2. **C# 语言版本限制为 7.3**，避免使用更高版本的语法特性
3. **确保所有项目使用相同的 .NET Framework 版本**
4. **在目标机器上测试**，确保所有依赖项都可用